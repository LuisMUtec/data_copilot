<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliente MCP PostgreSQL - Conexi√≥n Directa</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .mcp-badge {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .connection-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }
        .query-section {
            margin-bottom: 30px;
        }
        .query-input {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        .query-input:focus {
            border-color: #667eea;
            outline: none;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .mcp-tools {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .tool-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tool-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        .tool-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .tool-description {
            font-size: 12px;
            color: #666;
        }
        .results {
            margin-top: 30px;
        }
        .result-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .table-result {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
            font-size: 12px;
        }
        .table-result th, .table-result td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .table-result th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
        }
        .table-result tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        .metric-label {
            font-size: 12px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó Cliente MCP PostgreSQL</h1>
            <p>Conexi√≥n directa al Model Context Protocol <span class="mcp-badge">MCP</span></p>
        </div>

        <div id="connectionStatus" class="connection-status status info">
            <div class="loading"></div>
            Conectando al MCP...
        </div>

        <div class="connection-panel">
            <h3>üì° Estado de Conexi√≥n MCP</h3>
            <div id="mcpInfo">
                <p><strong>Estado:</strong> <span id="mcpStatus">Conectando...</span></p>
                <p><strong>Endpoint:</strong> ws://localhost:3002</p>
                <p><strong>Protocolo:</strong> WebSocket + JSON-RPC</p>
                <p><strong>Herramientas:</strong> <span id="toolCount">Cargando...</span></p>
            </div>
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="requestCount">0</div>
                    <div class="metric-label">Consultas</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="responseTime">0ms</div>
                    <div class="metric-label">Tiempo Resp.</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="errorCount">0</div>
                    <div class="metric-label">Errores</div>
                </div>
            </div>
        </div>

        <div class="query-section">
            <h3>üõ†Ô∏è Herramientas MCP Disponibles</h3>
            <div id="mcpTools" class="mcp-tools">
                <div class="tool-card">
                    <div class="tool-name">Cargando herramientas...</div>
                    <div class="tool-description">Conectando al servidor MCP</div>
                </div>
            </div>
        </div>

        <div class="query-section">
            <h3>üìù Consulta Personalizada</h3>
            <textarea id="queryInput" class="query-input" placeholder="Escribe tu consulta SQL aqu√≠ o usa las herramientas MCP arriba...
Ejemplo: SELECT * FROM employees LIMIT 10;"></textarea>
            
            <div class="buttons">
                <button class="btn btn-primary" onclick="executeCustomQuery()" id="executeBtn">
                    üöÄ Ejecutar con MCP
                </button>
                <button class="btn btn-secondary" onclick="clearQuery()">
                    üóëÔ∏è Limpiar
                </button>
                <button class="btn btn-info" onclick="getSchema()">
                    üìã Ver Esquema
                </button>
                <button class="btn btn-success" onclick="analyzeWithAI()">
                    ü§ñ Analizar con AI
                </button>
            </div>
        </div>

        <div class="results">
            <h3>üìä Resultados del MCP</h3>
            <div id="statusMessage"></div>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const WS_URL = 'ws://localhost:3002';
        const GOOGLE_API_KEY = 'AIzaSyA3e8v6QI88u6b_jyUQQY8W2peT5E4uHmg';

        // Estado de la aplicaci√≥n
        let ws = null;
        let isConnected = false;
        let requestId = 0;
        let pendingRequests = new Map();
        let availableTools = [];
        let metrics = {
            requestCount: 0,
            errorCount: 0,
            responseTime: 0
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            connectToMCP();
        });

        // Conectar al MCP v√≠a WebSocket
        function connectToMCP() {
            showStatus('üîÑ Conectando al MCP PostgreSQL...', 'info');
            
            try {
                ws = new WebSocket(WS_URL);
                
                ws.onopen = function() {
                    console.log('‚úÖ Conectado al MCP WebSocket Proxy');
                    updateConnectionStatus(true);
                    showStatus('‚úÖ Conectado al MCP PostgreSQL', 'success');
                };

                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleMCPMessage(message);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                ws.onclose = function() {
                    console.log('üîå Desconectado del MCP');
                    updateConnectionStatus(false);
                    showStatus('‚ùå Conexi√≥n MCP perdida. Reintentando...', 'error');
                    
                    // Reconectar despu√©s de 3 segundos
                    setTimeout(connectToMCP, 3000);
                };

                ws.onerror = function(error) {
                    console.error('Error en WebSocket:', error);
                    updateConnectionStatus(false);
                    showStatus('‚ùå Error de conexi√≥n MCP', 'error');
                };

            } catch (error) {
                console.error('Error creando WebSocket:', error);
                showStatus('‚ùå No se pudo conectar al MCP', 'error');
                setTimeout(connectToMCP, 5000);
            }
        }

        // Manejar mensajes del MCP
        function handleMCPMessage(message) {
            console.log('MCP Message:', message);

            switch (message.type) {
                case 'welcome':
                    console.log('Bienvenida del MCP:', message.message);
                    loadMCPTools();
                    break;

                case 'mcp-response':
                    handleMCPResponse(message);
                    break;

                default:
                    console.log('Mensaje MCP no reconocido:', message);
            }
        }

        // Manejar respuestas del MCP
        function handleMCPResponse(message) {
            const { id, success, result, error } = message;
            
            if (pendingRequests.has(id)) {
                const { resolve, reject, startTime } = pendingRequests.get(id);
                pendingRequests.delete(id);

                // Actualizar m√©tricas
                metrics.responseTime = Date.now() - startTime;
                updateMetrics();

                if (success) {
                    resolve(result);
                } else {
                    metrics.errorCount++;
                    updateMetrics();
                    reject(new Error(error));
                }
            }
        }

        // Enviar solicitud al MCP
        function sendMCPRequest(method, params = {}) {
            return new Promise((resolve, reject) => {
                if (!isConnected) {
                    reject(new Error('No hay conexi√≥n al MCP'));
                    return;
                }

                const id = ++requestId;
                const request = {
                    type: 'mcp-request',
                    id: id,
                    method: method,
                    params: params
                };

                pendingRequests.set(id, {
                    resolve,
                    reject,
                    startTime: Date.now()
                });

                ws.send(JSON.stringify(request));
                metrics.requestCount++;
                updateMetrics();

                // Timeout de 30 segundos
                setTimeout(() => {
                    if (pendingRequests.has(id)) {
                        pendingRequests.delete(id);
                        metrics.errorCount++;
                        updateMetrics();
                        reject(new Error('Request timeout'));
                    }
                }, 30000);
            });
        }

        // Cargar herramientas MCP disponibles
        async function loadMCPTools() {
            try {
                const result = await sendMCPRequest('tools/list');
                availableTools = result.tools || [];
                displayMCPTools();
                updateToolCount();
            } catch (error) {
                console.error('Error cargando herramientas MCP:', error);
                showStatus('‚ö†Ô∏è Error cargando herramientas MCP', 'warning');
            }
        }

        // Mostrar herramientas MCP
        function displayMCPTools() {
            const toolsContainer = document.getElementById('mcpTools');
            
            if (availableTools.length === 0) {
                toolsContainer.innerHTML = `
                    <div class="tool-card">
                        <div class="tool-name">Sin herramientas</div>
                        <div class="tool-description">No se encontraron herramientas MCP</div>
                    </div>
                `;
                return;
            }

            toolsContainer.innerHTML = availableTools.map(tool => `
                <div class="tool-card" onclick="useTool('${tool.name}')">
                    <div class="tool-name">${tool.name}</div>
                    <div class="tool-description">${tool.description}</div>
                </div>
            `).join('');
        }

        // Usar herramienta MCP
        async function useTool(toolName) {
            const tool = availableTools.find(t => t.name === toolName);
            if (!tool) return;

            let params = {};

            switch (toolName) {
                case 'execute_query':
                    const query = prompt('Ingresa la consulta SQL:');
                    if (!query) return;
                    params = { query };
                    break;

                case 'describe_table':
                    const tableName = prompt('Nombre de la tabla a describir:');
                    if (!tableName) return;
                    params = { table_name: tableName };
                    break;

                case 'get_schema':
                    // Sin par√°metros
                    break;

                default:
                    showStatus(`‚ö†Ô∏è Herramienta ${toolName} no implementada`, 'warning');
                    return;
            }

            try {
                showStatus(`üîÑ Ejecutando ${toolName}...`, 'info');
                const result = await sendMCPRequest('tools/call', {
                    name: toolName,
                    arguments: params
                });

                showStatus(`‚úÖ ${toolName} ejecutado exitosamente`, 'success');
                displayMCPResult(result, toolName);
            } catch (error) {
                showStatus(`‚ùå Error en ${toolName}: ${error.message}`, 'error');
            }
        }

        // Ejecutar consulta personalizada
        async function executeCustomQuery() {
            const query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                showStatus('‚ö†Ô∏è Por favor ingresa una consulta SQL', 'warning');
                return;
            }

            if (!isConnected) {
                showStatus('‚ùå No hay conexi√≥n al MCP', 'error');
                return;
            }

            const executeBtn = document.getElementById('executeBtn');
            executeBtn.disabled = true;
            executeBtn.innerHTML = '<div class="loading"></div> Ejecutando...';

            try {
                showStatus('üîÑ Ejecutando consulta con MCP...', 'info');
                
                const result = await sendMCPRequest('tools/call', {
                    name: 'execute_query',
                    arguments: { query }
                });

                showStatus('‚úÖ Consulta ejecutada exitosamente', 'success');
                displayMCPResult(result, 'execute_query');
            } catch (error) {
                showStatus(`‚ùå Error: ${error.message}`, 'error');
            } finally {
                executeBtn.disabled = false;
                executeBtn.innerHTML = 'üöÄ Ejecutar con MCP';
            }
        }

        // Obtener esquema
        async function getSchema() {
            try {
                showStatus('üîÑ Obteniendo esquema con MCP...', 'info');
                const result = await sendMCPRequest('tools/call', {
                    name: 'get_schema',
                    arguments: {}
                });
                showStatus('‚úÖ Esquema obtenido exitosamente', 'success');
                displayMCPResult(result, 'get_schema');
            } catch (error) {
                showStatus(`‚ùå Error obteniendo esquema: ${error.message}`, 'error');
            }
        }

        // Analizar con AI (preparado para Google AI)
        async function analyzeWithAI() {
            const query = document.getElementById('queryInput').value.trim();
            
            if (!query) {
                showStatus('‚ö†Ô∏è Ingresa una consulta para analizar', 'warning');
                return;
            }

            try {
                showStatus('ü§ñ Analizando con Google AI...', 'info');
                
                // Primero ejecutar la consulta
                const queryResult = await sendMCPRequest('tools/call', {
                    name: 'execute_query',
                    arguments: { query }
                });

                // Simular an√°lisis con Google AI
                const analysis = await analyzeDataWithGoogleAI(queryResult);
                
                showStatus('‚úÖ An√°lisis completado', 'success');
                displayAIAnalysis(analysis, queryResult);
            } catch (error) {
                showStatus(`‚ùå Error en an√°lisis: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para an√°lisis con Google AI (preparado)
        async function analyzeDataWithGoogleAI(data) {
            if (!GOOGLE_API_KEY) {
                return {
                    analysis: "Google AI API Key no disponible",
                    insights: ["Configura el API key para an√°lisis reales"],
                    recommendations: ["Verificar configuraci√≥n de Google AI"]
                };
            }

            // Aqu√≠ ir√≠a la integraci√≥n real con Google AI
            return {
                analysis: "An√°lisis simulado con Google AI",
                insights: [
                    "Datos estructurados detectados correctamente",
                    "Patr√≥n de consulta optimizable identificado",
                    "Resultados consistentes con esquema de BD"
                ],
                recommendations: [
                    "Considera usar √≠ndices en columnas frecuentemente consultadas",
                    "Optimiza JOINs complejos para mejor rendimiento",
                    "Revisa normalizaci√≥n de datos si es necesario"
                ]
            };
        }

        // Mostrar resultado del MCP
        function displayMCPResult(result, toolName) {
            const container = document.getElementById('resultsContainer');
            
            // Extraer contenido del formato MCP
            let content = result;
            if (result.content && Array.isArray(result.content)) {
                content = result.content[0]?.text || result.content[0] || result;
                try {
                    content = JSON.parse(content);
                } catch (e) {
                    // No es JSON, usar como est√°
                }
            }

            if (typeof content === 'string') {
                try {
                    content = JSON.parse(content);
                } catch (e) {
                    // No es JSON v√°lido
                }
            }

            let html = '';

            if (toolName === 'execute_query' && content.rows) {
                html = formatQueryResults(content);
            } else if (toolName === 'get_schema' && content.tables) {
                html = formatSchemaResults(content);
            } else if (toolName === 'describe_table' && content.columns) {
                html = formatTableDescription(content);
            } else {
                html = `<div class="result-box">${JSON.stringify(content, null, 2)}</div>`;
            }

            container.innerHTML = html;
        }

        // Formatear resultados de consulta
        function formatQueryResults(data) {
            if (!data.rows || data.rows.length === 0) {
                return `<div class="result-box">No se encontraron registros</div>`;
            }

            const headers = Object.keys(data.rows[0]);
            return `
                <div class="result-box">
                    <strong>üìä Resultados (${data.rows.length} registros):</strong>
                    <table class="table-result">
                        <thead>
                            <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${data.rows.map(row => 
                                `<tr>${headers.map(h => `<td>${formatCellValue(row[h])}</td>`).join('')}</tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Formatear valor de celda
        function formatCellValue(value) {
            if (value === null || value === undefined) return '<em>null</em>';
            if (typeof value === 'object') return JSON.stringify(value);
            if (typeof value === 'string' && value.length > 100) {
                return value.substring(0, 100) + '...';
            }
            return value;
        }

        // Formatear esquema
        function formatSchemaResults(schema) {
            return `
                <div class="result-box">
                    <strong>üìã Esquema de Base de Datos (${schema.tables.length} tablas):</strong>
                    <ul>
                        ${schema.tables.map(table => `
                            <li><strong>${table.table_name}</strong> (${table.columns.length} columnas)</li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        // Formatear descripci√≥n de tabla
        function formatTableDescription(tableDesc) {
            return `
                <div class="result-box">
                    <strong>üîç Descripci√≥n de tabla: ${tableDesc.table_name}</strong>
                    <table class="table-result">
                        <thead>
                            <tr>
                                <th>Columna</th>
                                <th>Tipo</th>
                                <th>Nullable</th>
                                <th>Default</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableDesc.columns.map(col => `
                                <tr>
                                    <td><strong>${col.column_name}</strong></td>
                                    <td>${col.data_type}</td>
                                    <td>${col.is_nullable}</td>
                                    <td>${col.column_default || '<em>null</em>'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Mostrar an√°lisis de AI
        function displayAIAnalysis(analysis, queryResult) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="result-box">
                    <strong>ü§ñ An√°lisis con Google AI:</strong>
                    <p><strong>An√°lisis:</strong> ${analysis.analysis}</p>
                    <p><strong>Insights:</strong></p>
                    <ul>${analysis.insights.map(insight => `<li>${insight}</li>`).join('')}</ul>
                    <p><strong>Recomendaciones:</strong></p>
                    <ul>${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}</ul>
                </div>
                <div class="result-box">
                    <strong>üìä Datos analizados:</strong>
                    ${JSON.stringify(queryResult, null, 2)}
                </div>
            `;
        }

        // Utilidades
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = `<span>${getStatusIcon(type)}</span> ${message}`;
        }

        function getStatusIcon(type) {
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            return icons[type] || '‚ÑπÔ∏è';
        }

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const mcpStatusEl = document.getElementById('mcpStatus');
            
            if (connected) {
                statusEl.className = 'connection-status status success';
                statusEl.innerHTML = '‚úÖ MCP Conectado';
                mcpStatusEl.textContent = 'Conectado y listo';
                isConnected = true;
            } else {
                statusEl.className = 'connection-status status error';
                statusEl.innerHTML = '‚ùå MCP Desconectado';
                mcpStatusEl.textContent = 'Desconectado';
                isConnected = false;
            }
        }

        function updateToolCount() {
            document.getElementById('toolCount').textContent = `${availableTools.length} herramientas disponibles`;
        }

        function updateMetrics() {
            document.getElementById('requestCount').textContent = metrics.requestCount;
            document.getElementById('responseTime').textContent = `${metrics.responseTime}ms`;
            document.getElementById('errorCount').textContent = metrics.errorCount;
        }

        function clearQuery() {
            document.getElementById('queryInput').value = '';
            document.getElementById('resultsContainer').innerHTML = '';
            showStatus('üóëÔ∏è Consulta limpiada', 'info');
        }
    </script>
</body>
</html>
